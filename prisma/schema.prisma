// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "../app/generated/prisma"
  previewFeatures = ["relationJoins"]
  engineType      = "client"
}

datasource db {
  provider = "postgresql"
}

model Farm {
  id               String    @id @default(cuid())
  name             String
  businessName     String?
  lotSectionPlan   String[]
  abn              String?
  acn              String?
  pic              String?
  // livestockUnits LivestockUnit[]
  // paddocks       Paddock[]
  locationCentre   GeoPoint? @relation(fields: [locationCentreId], references: [id])
  locationCentreId String?
  areaHa           Float?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime? @updatedAt
  users            User[]

  studs Stud[]

  onFarms OnFarm[]

  organizations Organization[] @relation("OrganizationFarms")
}

model User {
  id            String    @id @default(cuid())
  firstName     String
  preferredName String?
  lastName      String
  farm          Farm      @relation(fields: [farmId], references: [id])
  farmId        String
  name          String
  email         String
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]
  mobileNumber  String?
  landlineNumber String?
  members           Member[]
  invitations       Invitation[]
  billingAddresses  Address[]      @relation(name: "UserBillingAddress")
  shippingAddresses Address[]      @relation(name: "UserShippingAddress")
  organizations     Organization[]

  @@unique([email])
  @@map("user")
}

model Address {
  id             String        @id @default(cuid())
  unit           Int?
  streetNumber   Int
  streetName     String
  streetType     String
  suburb         String
  state          State
  country        String
  postCode       Int
  billingUser    User?         @relation(name: "UserBillingAddress", fields: [billingUserid], references: [id])
  billingUserid  String?
  shippingUser   User?         @relation(name: "UserShippingAddress", fields: [shippingUserid], references: [id])
  shippingUserid String?
  billingOrg     Organization? @relation(name: "OrgBillingAddress", fields: [billingOrgid], references: [id])
  billingOrgid   String?
  shippingOrg    Organization? @relation(name: "OrgShippingAddress", fields: [shippingOrgid], references: [id])
  shippingOrgid  String?
}

model Graze {
  id                String     @id @default(cuid())
  startDatetime     DateTime
  endDateTime       DateTime?
  paddock           Paddock    @relation(fields: [paddockId], references: [id])
  paddockId         String     @unique
  mobs              GrazeMob[]
  dseDaysPerHectare Float?
}

model Breed {
  id              String         @id @default(cuid())
  name            String
  class           StockClass
  members         LivestockUnit? @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId String         @unique
}

model Mob {
  id      String          @id @default(cuid())
  name    String?
  members LivestockUnit[]
  comment String?
  grazes  GrazeMob[]
}

model GrazeMob {
  graze   Graze  @relation(fields: [grazeId], references: [id])
  grazeId String
  mob     Mob    @relation(fields: [mobId], references: [id])
  mobId   String

  @@id([grazeId, mobId])
}

model LivestockUnit {
  id                           String                         @id @default(cuid())
  nlisId                       String?
  visualIdLine1                String?
  visualIdLine2                String?
  visualIdLine3                String?
  visualIdBackgroundColour     VisualIdColour?
  visualIdTextColour           VisualIdColour?
  class                        StockClass
  commercialClass              CommercialClass?
  breed                        Breed?
  name                         String?
  comment                      String?
  sex                          Sex
  birthDate                    DateTime
  desexed                      Boolean
  sireId                       String?
  sire                         LivestockUnit?                 @relation("SIRED", fields: [sireId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sired                        LivestockUnit[]                @relation("SIRED")
  damId                        String?
  dam                          LivestockUnit?                 @relation("BIRTHED", fields: [damId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  birthed                      LivestockUnit[]                @relation("BIRTHED")
  mob                          Mob?                           @relation(fields: [mobRef], references: [id])
  mobRef                       String?
  pregnancies                  LivestockUnitPregnancy[]
  weights                      WeightRecord[]
  treatments                   ChemicalTreatment[]
  drySheepEquivalent           Int                            @default(1)
  purchasePrice                Float?
  purchaseDate                 DateTime?
  angusTechId                  String?
  active                       Boolean                        @default(true)
  estimatedBreedingValueResult EstimatedBreedingValueResult[]
  onFarmHistory                OnFarm[]
  birthStud                    Stud[]
  ownershipHistory             Ownership[]
}

model OnFarm {
  id              String        @id @default(cuid())
  livestockUnit   LivestockUnit @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId String
  farm            Farm          @relation(fields: [farmId], references: [id])
  farmId          String
  startDate       DateTime?
  endDate         DateTime?
}

model Ownership {
  id              String        @id @default(cuid())
  livestockUnit   LivestockUnit @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId String
  organization    Organization  @relation(fields: [organizationId], references: [id])
  organizationId  String
  startDate       DateTime
  endDate         DateTime?
}

model Stud {
  id                String                    @id @default(cuid())
  name              String
  description       String?
  farms             Farm[]
  registrations     StudSocietyRegistration[]
  liveStockBornHere LivestockUnit[]
}

model StudSocietyRegistration {
  id                     String      @id @default(cuid())
  society                StudSociety @relation(fields: [societyId], references: [id])
  societyId              String
  studRegistrationNumber String?
  studRegistrationName   String?
  studRegistrationPrefix String?
  stud                   Stud        @relation(fields: [studId], references: [id])
  studId                 String
}

model StudSociety {
  id          String                    @id @default(cuid())
  name        String
  description String?
  studs       StudSocietyRegistration[]
}

model Pregnancy {
  id                         String                   @id @default(cuid())
  earliestPossibleConception DateTime?
  latestPossibleConception   DateTime?
  conception                 DateTime?
  dueDate                    DateTime?
  earliestPossibleBirth      DateTime?
  latestPossibleBirth        DateTime?
  parents                    LivestockUnitPregnancy[]
  pregnancySireId            String
  pregnancyTest              PregnancyTest[]
}

model LivestockUnitPregnancy {
  livestockUnit   LivestockUnit @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId String
  pregnancy       Pregnancy     @relation(fields: [pregnancyId], references: [id])
  pregnancyId     String

  @@id([livestockUnitId, pregnancyId])
}

model PregnancyTest {
  id          String              @id @default(cuid())
  testDate    DateTime
  testType    PregnancyTestType
  resultDate  DateTime
  result      PregnancyTestResult
  pregnancyId String              @unique
  pregnancy   Pregnancy           @relation(fields: [pregnancyId], references: [id])
  cost        Float?
}

enum PregnancyTestResult {
  PREGNANT
  NOT_PREGNANT
  INCONCLUSIVE
}

enum PregnancyTestType {
  MANUAL_RECTAL_PALPATATION
  ULTRASOUND
  BIOPRYN
}

model ChemicalTreatment {
  id                String            @id @default(cuid())
  liveStockUnit     LivestockUnit     @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId   String
  treatmentDate     DateTime
  applicationMethod ApplicationMethod
  product           ChemicalProduct   @relation(fields: [chemicalProductId], references: [id])
  chemicalProductId String
  volumeMl          Int
}

model ChemicalProduct {
  id                   String               @id @default(cuid())
  manufacturer         ChemicalManufacturer
  productName          ChemicalProductName
  serialNumber         String?
  batchNumber          String?
  volumeMl             Int?
  cost                 Float?
  type                 ChemicalType
  witholdingPeriodDays Int                  @default(0)
  activeIngredients    ActiveIngredient[]
  ChemicalTreatment    ChemicalTreatment[]
}

model ActiveIngredient {
  id         String          @id @default(cuid())
  ingredient Ingredient
  mgPermL    Float
  product    ChemicalProduct @relation(fields: [productId], references: [id])
  productId  String
}

model EstimatedBreedingValueDefinition {
  id                           String                         @id @default(cuid())
  name                         String
  code                         String
  category                     EbvCategory
  description                  String
  higherIsBetter               Boolean
  units                        Units
  measurement                  Measurement
  angusTechFieldNameValue      String?
  angusTechFieldNamePercentile String?
  angusTechFieldNameAccuracy   String?
  results                      EstimatedBreedingValueResult[]
}

model EstimatedBreedingValueResult {
  id                                 String                           @id @default(cuid())
  ebv                                EstimatedBreedingValueDefinition @relation(fields: [estimatedBreedingValueDefinitionId], references: [id])
  estimatedBreedingValueDefinitionId String
  value                              Float
  percentile                         Float
  accuracy                           Float
  livestockUnit                      LivestockUnit                    @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId                    String
}

enum Units {
  KILOGRAMS
  DAYS
  PERCENTAGE
  CENTIMETRES
  SQUARE_CENTIMETRES
  MILLIMETRES
  KILOGRAMS_PER_DAY
  STRUCTURAL_SCORE
  DOLLARS_AUSTRALIAN
}

enum Measurement {
  CARCASE_WEIGHT
  LIVE_WEIGHT
  CIRCUMFERENCE
  CALVING_UNASSISTED
  GESTATION
  DOCILE_CALVES
  MUSCLE_AREA
  FAT_DEPTH
  SALEABLE_BEEF
  INTRAMUSCULAR_FAT
  FEED_CONSUMED
  CLAW_SET
  FOOT_ANGLE
  LEG_ANGLE
  JOINING_TO_CALVING
  NET_PROFITABILITY
}

enum EbvCategory {
  CALVING_EASE
  GROWTH
  FERTILITY
  TEMPERAMENT
  CARCASE
  FEED_EFFICIENCY
  STRUCTURAL
  SELECTION_INDEX
}

enum Ingredient {
  TRICLABENDAZOLE
  ABAMECTIN
}

enum ChemicalType {
  DRENCH
  VACCINE
  SUPPLEMENT
  ANTIBIOTICS
}

enum ApplicationMethod {
  ORAL
  TRANSDERMAL
  SUB_CUT_INJECTION
  INTRAVENUS_INJECTION
}

enum VisualIdColour {
  WHITE
  ORANGE
  LIGHT_GREEN
  PURPLE
  YELLOW
  RED
  SKY_BLUE
  BLACK
}

model Paddock {
  id                      String                 @id @default(cuid())
  name                    String
  polygon                 GeoPoint[]
  areaHa                  Float
  graze                   Graze[]
  livestockUnitPosition   LivestockUnitPosition? @relation(fields: [livestockUnitPositionId], references: [id])
  livestockUnitPositionId String?                @unique
  // farm                    Farm                   @relation(fields: [farmId], references: [id])
  // farmId                  Int                    @unique
}

model LivestockUnitPosition {
  id       String    @id @default(cuid())
  date     DateTime
  location GeoPoint?
  paddock  Paddock?
}

model GeoPoint {
  id                      String                 @id @default(cuid())
  latitude                Float
  longitude               Float
  heading                 Float?
  paddock                 Paddock?               @relation(fields: [paddockId], references: [id])
  paddockId               String?
  livestockUnitPosition   LivestockUnitPosition? @relation(fields: [livestockUnitPositionId], references: [id])
  livestockUnitPositionId String?                @unique

  farms Farm[]
}

model WeightRecord {
  id              String        @id @default(cuid())
  weight          Float
  dateMeasured    DateTime      @default(now())
  method          WeighMethod   @default(SCALES)
  livestockUnit   LivestockUnit @relation(fields: [livestockUnitId], references: [id])
  livestockUnitId String
}

model LoraDevice {
  id               String               @id @default(cuid())
  name             String?
  deviceId         String
  deviceEui        String
  appEui           String
  appKey           String
  manufacturer     String?
  partNumber       String?
  activationMethod LoraActivationMethod @default(OTAA)
}

enum ChemicalManufacturer {
  BOEHRINGER_INGLEHEIM
}

enum ChemicalProductName {
  AVOMEC_PLUS_POUR_ON
}

enum LoraActivationMethod {
  OTAA
  ABP
}

enum StockClass {
  CATTLE
  SHEEP
  GOAT
  CAMEL
  ALPACA
  LLAMA
  CHICKEN
  DUCK
  TURKEY
}

enum WeighMethod {
  SCALES
  IMAGE_ANALYSIS
  VISUAL_ESTIMATE
  MOB_AVERAGE
}

enum Sex {
  MALE
  FEMALE
}

enum CommercialClass {
  COMMERCIAL
  SEEDSTOCK
  PET
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  activeOrganizationId String?

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Organization {
  id                String       @id
  name              String
  slug              String
  logo              String?
  createdAt         DateTime
  metadata          String?
  members           Member[]
  contactPersonId   String
  contactPerson     User         @relation(fields: [contactPersonId], references: [id], onDelete: Cascade)
  invitations       Invitation[]
  billingAddresses  Address[]    @relation(name: "OrgBillingAddress")
  shippingAddresses Address[]    @relation(name: "OrgShippingAddress")
  ownerships        Ownership[]
  farms             Farm[]       @relation("OrganizationFarms")
}

model Member {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String       @default("member")
  createdAt      DateTime

  @@index([organizationId])
  @@index([userId])
  @@map("member")
}

model Invitation {
  id             String       @id
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String       @default("pending")
  expiresAt      DateTime
  createdAt      DateTime     @default(now())
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([email])
  @@map("invitation")
}

enum State {
  ACT
  NSW
  QLD
  VIC
  SA
  NT
  WA
  TAS
}
